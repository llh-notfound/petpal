import{r as e,o,p as l,A as n,c as s,w as a,i as c,a as t,b as i,j as r,d as u,e as p,x as f,B as g,k as d,s as m,C as _,h,n as k,u as v,D as y,E as x,z as b,G as w}from"./index-BC-mzwrj.js";import{g as I,p as C,u as j,a as L}from"./index.U0t-2fq9.js";import{_ as U}from"./_plugin-vue_export-helper.BCo6x5W8.js";const A=()=>I("/common/user-policy"),N=()=>I("/common/privacy-policy"),G=U({__name:"login",setup(I){const C=e(!1);o((()=>{j()}));const j=()=>{try{const e=l("token"),o=l("userInfo");e&&o&&n()}catch(e){console.error("检查登录状态失败",e)}},U=()=>{C.value=!C.value},G=()=>{C.value?k({url:"/pages/login/phone-login"}):d({title:"请先同意用户协议和隐私政策",icon:"none"})},T=()=>{C.value?k({url:"/pages/login/account-login"}):d({title:"请先同意用户协议和隐私政策",icon:"none"})},z=()=>{C.value?d({title:"已关闭模拟登录功能",icon:"none"}):d({title:"请先同意用户协议和隐私政策",icon:"none"})},B=e=>{if(C.value)if(console.log("微信登录回调",e),"getUserInfo:ok"===e.detail.errMsg){const o=e.detail.userInfo;m({title:"登录中..."}),_({provider:"weixin",success:e=>{console.log("获取登录凭证成功",e.code),L.wxLogin(e.code,o).then((e=>{D(e.data,o)})).catch((e=>{console.error("登录失败",e),d({title:e.message||"登录失败，请重试",icon:"none"})})).finally((()=>{h()}))},fail:e=>{console.error("微信登录失败",e),h(),d({title:"微信登录失败，请重试",icon:"none"})}})}else d({title:"您取消了授权",icon:"none"});else d({title:"请先同意用户协议和隐私政策",icon:"none"})},D=(e,o)=>{const l={token:e.token,userId:e.userId,nickname:o.nickName,avatar:o.avatarUrl,memberLevel:e.memberLevel||"普通会员",petAvatar:e.petAvatar||"/static/images/pet.png"};v("userInfo",JSON.stringify(l)),v("token",e.token),y("userLogin"),d({title:"登录成功",icon:"success"}),e.isNewUser?setTimeout((()=>{k({url:"/pages/profile/pet-info"})}),1500):setTimeout((()=>{try{const e=x();console.log("当前页面栈:",e),e.length>1?n():b({url:"/pages/profile/profile",fail:e=>{console.error("切换到个人中心失败:",e),w({url:"/pages/profile/profile"})}})}catch(e){console.error("导航错误:",e),b({url:"/pages/profile/profile"})}}),1500)},E=()=>{A().then((e=>{k({url:"/pages/common/user-policy"})})).catch((e=>{console.error("获取用户协议失败",e),k({url:"/pages/common/user-policy"})}))},J=()=>{N().then((e=>{k({url:"/pages/common/privacy-policy"})})).catch((e=>{console.error("获取隐私政策失败",e),k({url:"/pages/common/privacy-policy"})}))};return(e,o)=>{const l=r,n=u,d=c,m=f,_=g;return t(),s(d,{class:"login-container"},{default:a((()=>[i(d,{class:"login-header"},{default:a((()=>[i(l,{class:"logo",src:"/petpal/static/images/logo.png"}),i(n,{class:"welcome"},{default:a((()=>[p("欢迎使用petpal")])),_:1})])),_:1}),i(d,{class:"login-options"},{default:a((()=>[i(d,{class:"login-card"},{default:a((()=>[i(d,{class:"login-title"},{default:a((()=>[p("登录/注册")])),_:1}),i(d,{class:"login-desc"},{default:a((()=>[p("登录后享受更多会员特权")])),_:1}),i(m,{class:"wechat-login-btn","open-type":"getUserInfo",onGetuserinfo:B},{default:a((()=>[i(n,{class:"wechat-icon iconfont icon-wechat"}),i(n,null,{default:a((()=>[p("微信一键登录")])),_:1})])),_:1}),i(d,{class:"phone-login-btn",onClick:G},{default:a((()=>[i(n,{class:"phone-icon iconfont icon-phone"}),i(n,null,{default:a((()=>[p("手机号登录")])),_:1})])),_:1}),i(d,{class:"account-login-btn",onClick:T},{default:a((()=>[i(n,{class:"account-icon iconfont icon-user"}),i(n,null,{default:a((()=>[p("账号密码登录")])),_:1})])),_:1}),i(d,{class:"mock-login-btn",onClick:z},{default:a((()=>[i(n,{class:"mock-icon iconfont icon-user"}),i(n,null,{default:a((()=>[p("虚拟用户登录")])),_:1})])),_:1})])),_:1})])),_:1}),i(d,{class:"agreement"},{default:a((()=>[i(_,{checked:C.value,onClick:U,class:"agreement-checkbox"},null,8,["checked"]),i(n,{class:"agreement-text"},{default:a((()=>[p("登录即表示您已同意")])),_:1}),i(n,{class:"policy-link",onClick:E},{default:a((()=>[p("《用户协议》")])),_:1}),i(n,{class:"agreement-text"},{default:a((()=>[p("和")])),_:1}),i(n,{class:"policy-link",onClick:J},{default:a((()=>[p("《隐私政策》")])),_:1})])),_:1})])),_:1})}}},[["__scopeId","data-v-bc850bce"]]);export{G as default};
